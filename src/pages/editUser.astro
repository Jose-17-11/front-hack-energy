---
import Button from "@components/common/Button.astro";
import Layout from '../layouts/Layout.astro';
import BaseL from '../layouts/BaseLayout.astro';
import pool from '../database/conexion';
---
<Layout title="LowerG"> 
    <main>
      <BaseL>
        <section class="w-full h-full flex items-center justify-center mt-20">
          <form class="rounded-xl col-span-1 flex items-center justify-center w-full">
            <div class="w-96 h-full flex flex-col justify-center items-center gap-6">
              <h1 class="text-2xl font-semibold text-center">
                Administración de Usuarios
              </h1>
              <h3 class="text-3xl font-semibold text-center mt-2">
                Editar usuario
              </h3>
  
              <input required id="nombre" type="text" name="nombre" placeholder="Nombre" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="apellidoP" type="text" name="apellidoP" placeholder="Apellido Paterno" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="apellidoM" type="text" name="apellidoM" placeholder="Apellido Materno" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="edad" type="number" name="edad" placeholder="Edad" min="13" max="99" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="pais" type="text" name="pais" placeholder="País" maxlength="50" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="correo" type="email" name="correo" placeholder="Correo" maxlength="50" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="telefono" type="tel" name="telefono" placeholder="Teléfono" maxlength="10" pattern="[0-9]*" class="w-full bg-transparent border-b-2 focus:outline-none">
  
              <Button types="submit" class="w-full mt-4">
                  <p class="text-white">Actualizar</p>
              </Button>           
            </div>
          </form>
        </section>
      </BaseL>
    </main>
  </Layout>
  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Obtén el parámetro `id` de la URL
      const userId = new URLSearchParams(window.location.search).get("id");
  
      if (!userId) {
        alert("No se proporcionó un ID de usuario");
        return;
      }
  
      try {
        const response = await fetch(`http://localhost:5000/api/getUser/${userId}`);
        if (response.ok) {
          const user = await response.json();
          document.getElementById("nombre").value = user.nombre;
          document.getElementById("apellidoP").value = user.apellidoP;
          document.getElementById("apellidoM").value = user.apellidoM;
          document.getElementById("edad").value = user.edad;
          document.getElementById("pais").value = user.pais;
          document.getElementById("correo").value = user.correo;
          document.getElementById("telefono").value = user.telefono;
        } else {
          alert("Error al obtener los datos del usuario");
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Error al obtener los datos del usuario");
      }
  
      const form = document.querySelector("form");
      form?.addEventListener("submit", async (event) => {
        event.preventDefault();
  
        const data = {
          nombre: document.getElementById("nombre").value,
          apellidoP: document.getElementById("apellidoP").value,
          apellidoM: document.getElementById("apellidoM").value,
          edad: parseInt(document.getElementById("edad").value),
          pais: document.getElementById("pais").value,
          correo: document.getElementById("correo").value,
          telefono: document.getElementById("telefono").value,
        };
  
        try {
          const response = await fetch(`http://localhost:5000/api/updateUser/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
  
          if (response.ok) {
            alert("Usuario actualizado correctamente");
            window.location.href = "/adminUser"; // Redirige a la página de administración
          } else {
            alert("Error al actualizar el usuario");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al actualizar el usuario");
        }
      });
    });
  </script>
  
  