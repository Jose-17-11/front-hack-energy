---
import Button from "@components/common/Button.astro";
import Layout from '../layouts/Layout.astro';
import BaseL from '../layouts/BaseLayout.astro';
import pool from '../database/conexion';

---
<Layout title="LowerG"> 
	<main>
		<BaseL>
      <section class="w-full h-full flex items-center justify-center mt-16">
        <form class="rounded-xl col-span-1 flex items-center justify-center w-full">
            <div class="w-96 h-full flex flex-col justify-center items-center gap-6">
              <h1 class="text-2xl font-semibold text-center">
                Administración de Usuarios
              </h1>
              <h3 class="text-3xl font-semibold text-center mt-2">
                  Crear usuario
              </h3>
              <input required id="nombre" type="text" name="nombre" placeholder="Nombre" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="apellidoP" type="text" name="apellidoP" placeholder="Apellido Paterno" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="apellidoM" type="text" name="apellidoM" placeholder="Apellido Materno" maxlength="30" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="edad" type="number" name="edad" placeholder="Edad" min="13" max="99" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="pais" type="text" name="pais" placeholder="País" maxlength="50" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="correo" type="email" name="correo" placeholder="Correo" maxlength="50" class="w-full bg-transparent border-b-2 focus:outline-none">
              <input required id="telefono" type="tel" name="telefono" placeholder="Teléfono" maxlength="10" pattern="[0-9]*" class="w-full bg-transparent border-b-2 focus:outline-none">
              <Button types="submit" class="w-full mt-4">
                  <p class="text-white">Agregar</p>
              </Button>           
            </div>
        </form>
      </section>
		</BaseL>
	</main>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    if (!form) return;

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Obtener valores de los inputs
      const nombre = (document.getElementById("nombre") as HTMLInputElement).value;
      const apellidoP = (document.getElementById("apellidoP") as HTMLInputElement).value;
      const apellidoM = (document.getElementById("apellidoM") as HTMLInputElement).value;
      const edad = parseInt((document.getElementById("edad") as HTMLInputElement).value);
      const pais = (document.getElementById("pais") as HTMLInputElement).value;
      const correo = (document.getElementById("correo") as HTMLInputElement).value;
      const telefono = (document.getElementById("telefono") as HTMLInputElement).value;

      let isValid = true;
      let errorMessage = "";

      // Validación de edad (máximo 2 dígitos, entre 13 y 99)
      if (isNaN(edad) || edad < 13 || edad > 99) {
        isValid = false;
        errorMessage += "La edad debe ser un número entre 13 y 99.\n";
      }

      if (isValid) {
        const data = {
          nombre,
          apellidoP,
          apellidoM,
          edad,
          pais,
          correo,
          telefono,
        };

        try {
            const response = await fetch('http://localhost:5000/api/addUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });


            if (response.ok) {
                alert("Usuario agregado correctamente");
                window.location.href = "/adminUser"; // Redirige a la página de administración
            } else {
                alert("Error al agregar el usuario");
            }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al agregar el usuario");
        }
      } else {
        alert(errorMessage);
      }
    });
  });
</script>
